#include <stdint.h>
#include <stdbool.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

#ifdef RTOS_SDK
#include <esp_common.h>
#else
#include <user_interface.h>
#include <wpa2_enterprise.h>
#endif

#include "common/cs_dbg.h"

#include "mgos_app.h"
#include "mgos_sys_config.h"
#include "mgos_system.h"
#include "mgos_timers.h"

uint8_t frame[800] = {
    0x80, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06,
    0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0xc0, 0x6c,
    0x83, 0x51, 0xf7, 0x8f, 0x0f, 0x00, 0x00, 0x00,
    0x64, 0x00, 0x01, 0x04, 0x00, 0x06, 0x72, 0x72,
    0x72, 0x72, 0x72, 0x72, 0x01, 0x08, 0x82, 0x84,
    0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03, 0x01,
    0x0b, 0x80, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0x01, 0x02, 0x03, 0x04, 0x05,
    0x06, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0xc0,
    0x6c, 0x83, 0x51, 0xf7, 0x8f, 0x0f, 0x00, 0x00,
    0x00, 0x64, 0x00, 0x01, 0x04, 0x00, 0x06, 0x72,
    0x72, 0x72, 0x72, 0x72, 0x72, 0x01, 0x08, 0x82,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x80, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06,
    0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0xc0, 0x6c,
    0x83, 0x51, 0xf7, 0x8f, 0x0f, 0x00, 0x00, 0x00,
    0x64, 0x00, 0x01, 0x04, 0x00, 0x06, 0x72, 0x72,
    0x72, 0x72, 0x72, 0x72, 0x01, 0x08, 0x82, 0x84,
    0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03, 0x01,
    0x0b, 0x80, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0x01, 0x02, 0x03, 0x04, 0x05,
    0x06, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0xc0,
    0x6c, 0x83, 0x51, 0xf7, 0x8f, 0x0f, 0x00, 0x00,
    0x00, 0x64, 0x00, 0x01, 0x04, 0x00, 0x06, 0x72,
    0x72, 0x72, 0x72, 0x72, 0x72, 0x01, 0x08, 0x82,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03,
    0x84, 0x8b, 0x96, 0x24, 0x30, 0x48, 0x6c, 0x03
};

// uint8_t symbol[3] = {
//     1, 1, 0
// };
uint8_t symbol[7] = {
    1, 1, 1, 0, 1, 0, 0
};
// uint8_t symbol[15] = {
//     1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0
// };
unsigned int symbol_length = sizeof(symbol)/sizeof(symbol[0]);

uint8_t data[1] = {1};
unsigned int data_length = sizeof(data)/sizeof(data[0]);

unsigned int symbol_index = 0;
unsigned int data_index = 0;
unsigned int sequence_length = 0;

unsigned int done_wait = 100;
unsigned int pause_time = 7000;

uint8_t MAX_SEQUENCE_LENGTH = 15;
unsigned int MIN_FRAME_SIZE = 785;
uint8_t INCREMENT_FRAME_SIZE = 52;


static void send_symbol(void *arg) {
    if(data_index >= data_length) {
        if(done_wait > 0) {
            // Wait awhile before starting over
            done_wait -= 1;
            return;
        }
        else {
            // Start over
            done_wait = 100;
            symbol_index = 0;
            data_index = 0;
            sequence_length = 0;
        }
    }

    if(symbol[symbol_index] == data[data_index]) {
        // Send a frame
        wifi_send_pkt_freedom(frame, MIN_FRAME_SIZE, 0);
        // printf("~~~~~~~~~~~~~~~~~~~~~Sending frame: %d\n", MIN_FRAME_SIZE);
    }
    else {
        // Do nothing
        // printf("~~~~~~~~~~~~~~~~~~~~~Zero: %d %d\n", symbol_index, data_index);
    }

    // Take care of incrementing indexes
    symbol_index += 1;

    if(symbol_index >= symbol_length) {
        // Done with that symbol so time to go to next bit
        symbol_index = 0;
        data_index += 1;
    }

    // printf("Done: %d %d\n", symbol_index, data_index);

    (void) arg;
}


static void start(void *arg) {
    printf("Starting...\n");
    mgos_set_hw_timer(pause_time, MGOS_TIMER_REPEAT, send_symbol, NULL);

    (void) arg;
}

enum mgos_app_init_result mgos_app_init(void) {
    int pause_time = mgos_sys_config_get_onpc_pause_time();
    int beacon_size = mgos_sys_config_get_onpc_beacon_size();

    wifi_set_opmode(STATION_MODE);
    wifi_set_channel(6);

    printf("Entering inject mode!\n");
    printf("Pause time: %d\n", pause_time);
    printf("Beacon size: %d\n", beacon_size);
    printf("Symbol size: %d\n", symbol_length);
    printf("Data size: %d\n", data_length);

    mgos_set_timer(3000, 0, start, NULL);

    return MGOS_APP_INIT_SUCCESS;
}
